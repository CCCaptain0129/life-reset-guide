<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæˆäººç”Ÿé‡ç½®åœ°å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .map-preview {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .map-content {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .action-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        }
        
        .templates {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .template-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #667eea;
            transition: transform 0.3s;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
        }
        
        .template-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .template-card p {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .back-link {
            text-align: center;
            margin-top: 30px;
        }
        
        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>äººç”Ÿé‡ç½®åœ°å›¾ç”Ÿæˆå™¨</h1>
            <p>åŸºäºä½ çš„å›ç­”ï¼Œç”Ÿæˆä¸ªæ€§åŒ–çš„äººç”Ÿé‡ç½®è®¡åˆ’</p>
        </header>
        
        <div class="map-preview">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">é¢„è§ˆä½ çš„äººç”Ÿé‡ç½®åœ°å›¾</h2>
            <div class="map-content" id="mapContent">
                æ­£åœ¨ç”Ÿæˆåœ°å›¾...
            </div>
        </div>
        
        <div class="actions">
            <button class="action-btn" onclick="downloadMap('markdown')">
                <span>ğŸ“¥</span> ä¸‹è½½Markdownæ–‡ä»¶
            </button>
            <button class="action-btn secondary" onclick="downloadMap('pdf')">
                <span>ğŸ“„</span> ä¸‹è½½PDFæ–‡ä»¶
            </button>
            <button class="action-btn success" onclick="printMap()">
                <span>ğŸ–¨ï¸</span> æ‰“å°åœ°å›¾
            </button>
            <button class="action-btn secondary" onclick="copyToClipboard()">
                <span>ğŸ“‹</span> å¤åˆ¶åˆ°å‰ªè´´æ¿
            </button>
        </div>
        
        <div class="templates">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">é…å¥—æ¨¡æ¿å·¥å…·</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">ä¸‹è½½è¿™äº›æ¨¡æ¿ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°æ‰§è¡Œè®¡åˆ’ï¼š</p>
            
            <div class="template-grid">
                <div class="template-card">
                    <h3>æ¯æ—¥å¤ç›˜æ¨¡æ¿</h3>
                    <p>è·Ÿè¸ªæ¯æ—¥è¿›å±•ï¼Œä¿æŒåŠ¨åŠ›</p>
                    <button class="action-btn secondary" style="padding: 8px 15px; font-size: 0.9rem;" onclick="downloadTemplate('daily-review')">
                        ä¸‹è½½æ¨¡æ¿
                    </button>
                </div>
                
                <div class="template-card">
                    <h3>å‘¨è®¡åˆ’æ¨¡æ¿</h3>
                    <p>è§„åˆ’æ¯å‘¨ä»»åŠ¡ï¼Œåˆ†è§£ç›®æ ‡</p>
                    <button class="action-btn secondary" style="padding: 8px 15px; font-size: 0.9rem;" onclick="downloadTemplate('weekly-plan')">
                        ä¸‹è½½æ¨¡æ¿
                    </button>
                </div>
                
                <div class="template-card">
                    <h3>èµ„æºæ¨èæ¸…å•</h3>
                    <p>ä¹¦ç±ã€æ’­å®¢ã€è¯¾ç¨‹æ¨è</p>
                    <button class="action-btn secondary" style="padding: 8px 15px; font-size: 0.9rem;" onclick="downloadTemplate('resources')">
                        æŸ¥çœ‹èµ„æº
                    </button>
                </div>
            </div>
        </div>
        
        <div class="back-link">
            <a href="/interactive.html">â† è¿”å›ä¿®æ”¹é—®å·ç­”æ¡ˆ</a> | 
            <a href="/">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        // å®‰å…¨çš„JSONè§£æå‡½æ•°
        function safeJSONParse(jsonString, defaultValue) {
            try {
                if (!jsonString || jsonString === 'null') {
                    return defaultValue;
                }
                
                // å…ˆå°è¯•ç›´æ¥è§£æ
                return JSON.parse(jsonString);
            } catch (error) {
                console.warn('JSONè§£æé”™è¯¯ï¼Œå°è¯•ä¿®å¤:', error.message);
                
                // å°è¯•ä¿®å¤å¸¸è§çš„JSONé—®é¢˜
                let fixedString = jsonString;
                
                // 1. ç§»é™¤æ§åˆ¶å­—ç¬¦
                fixedString = fixedString.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                
                // 2. ä¿®å¤æœªé—­åˆçš„å¼•å·
                const quoteCount = (fixedString.match(/"/g) || []).length;
                if (quoteCount % 2 !== 0) {
                    fixedString = fixedString.replace(/"([^"\\]*(\\.[^"\\]*)*)"?$/g, '"$1"');
                }
                
                // 3. ä¿®å¤æœªé—­åˆçš„æ‹¬å·
                const openBraces = (fixedString.match(/{/g) || []).length;
                const closeBraces = (fixedString.match(/}/g) || []).length;
                if (openBraces > closeBraces) {
                    fixedString += '}'.repeat(openBraces - closeBraces);
                }
                
                const openBrackets = (fixedString.match(/\[/g) || []).length;
                const closeBrackets = (fixedString.match(/\]/g) || []).length;
                if (openBrackets > closeBrackets) {
                    fixedString += ']'.repeat(openBrackets - closeBrackets);
                }
                
                try {
                    return JSON.parse(fixedString);
                } catch (secondError) {
                    console.error('ä¿®å¤åä»ç„¶æ— æ³•è§£æJSONï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    return defaultValue;
                }
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ç­”æ¡ˆï¼ˆä½¿ç”¨å®‰å…¨çš„JSONè§£æï¼‰
        const userAnswers = safeJSONParse(localStorage.getItem('lifeResetAnswers'), {});
        
        // ç”Ÿæˆäººç”Ÿé‡ç½®åœ°å›¾
        function generateLifeResetMap() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN');
            
            // æå–å…³é”®ç­”æ¡ˆ
            const vision = extractVision();
            const goals = extractGoals();
            const skills = extractSkills();
            const dailyRoutine = extractDailyRoutine();
            const strategy = extractStrategy();
            
            const mapContent = `# äººç”Ÿé‡ç½®åœ°å›¾

**ç”Ÿæˆæ—¶é—´ï¼š** ${dateStr}
**ç”¨æˆ·ï¼š** äººç”Ÿé‡ç½®å‘å¯¼ç”¨æˆ·

## æ„¿æ™¯å£°æ˜

${vision}

## ç›®æ ‡å±‚çº§

### é•¿æœŸç›®æ ‡ï¼ˆ5-10å¹´ï¼‰
${goals.longTerm}

### ä¸­æœŸç›®æ ‡ï¼ˆ1-3å¹´ï¼‰
${goals.midTerm}

### çŸ­æœŸç›®æ ‡ï¼ˆ1-12ä¸ªæœˆï¼‰
${goals.shortTerm}

### ç«‹å³ä¼˜å…ˆäº‹é¡¹ï¼ˆ1-4å‘¨ï¼‰
${goals.immediate}

## æŠ€èƒ½ä¸çŸ¥è¯†å‘å±•è®¡åˆ’

${skills}

## æ—¥å¸¸ç»“æ„ä¼˜åŒ–

${dailyRoutine}

## å®æ–½ç­–ç•¥

${strategy}

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³å¼€å§‹ï¼ˆ24å°æ—¶å†…ï¼‰ï¼š**
1. ä¿å­˜è¿™ä»½åœ°å›¾åˆ°å®‰å…¨çš„åœ°æ–¹
2. é€‰æ‹©1-2ä¸ªç«‹å³å¯ä»¥å¼€å§‹çš„è¡ŒåŠ¨
3. è®¾å®šç¬¬ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„æ£€æŸ¥æ—¶é—´

**æœ¬å‘¨å†…å®Œæˆï¼š**
1. ä¸‹è½½é…å¥—æ¨¡æ¿å·¥å…·
2. å»ºç«‹æ¯æ—¥å¤ç›˜ä¹ æƒ¯
3. åˆ¶å®šè¯¦ç»†çš„å‘¨è®¡åˆ’

---
*æ­¤åœ°å›¾ä¸ºåŠ¨æ€æ–‡æ¡£ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µéšæ—¶è°ƒæ•´ã€‚*
*ç”±äººç”Ÿé‡ç½®å‘å¯¼ç”Ÿæˆ - life-reset-guide.com*`;

            return mapContent;
        }

        // æå–æ„¿æ™¯
        function extractVision() {
            const stage3 = userAnswers.stage3 || [];
            if (stage3.length > 0 && stage3.some(a => a.trim())) {
                return `åŸºäºä½ çš„å›ç­”ï¼Œä½ çš„ç†æƒ³ç”Ÿæ´»æ˜¯ï¼š\n${stage3.filter(a => a.trim()).join('\n')}`;
            }
            return "åŸºäºä½ çš„å›ç­”ï¼Œä½ æ­£åœ¨å¯»æ±‚ä¸€ç§æ›´åŠ å……å®ã€è‡ªä¸»å’Œæœ‰æ„ä¹‰çš„ç”Ÿæ´»ã€‚å…·ä½“æ„¿æ™¯éœ€è¦è¿›ä¸€æ­¥æ˜ç¡®ã€‚";
        }

        // æå–ç›®æ ‡
        function extractGoals() {
            const stage4 = userAnswers.stage4 || [];
            
            const longTerm = stage4[0] ? `- ${stage4[0]}` : "- å»ºç«‹ç¨³å®šçš„è´¢åŠ¡åŸºç¡€\n- å‘å±•æœ‰æ„ä¹‰çš„äº‹ä¸š\n- ä¿æŒèº«å¿ƒå¥åº·";
            const midTerm = stage4[1] ? `- ${stage4[1]}` : "- å»ºç«‹æ”¶å…¥æ¥æº\n- å‘å±•æ ¸å¿ƒæŠ€èƒ½\n- ä¼˜åŒ–ç”Ÿæ´»ä¹ æƒ¯";
            const shortTerm = stage4[2] ? `- ${stage4[2]}` : "- å¼€å§‹æ¯æ—¥å¤ç›˜\n- å»ºç«‹å·¥ä½œèŠ‚å¥\n- å­¦ä¹ å¿…è¦çŸ¥è¯†";
            
            return {
                longTerm,
                midTerm,
                shortTerm,
                immediate: "1. å¼€å§‹ä½¿ç”¨æ¯æ—¥å¤ç›˜æ¨¡æ¿\n2. åˆ¶å®šç¬¬ä¸€å‘¨å…·ä½“è®¡åˆ’\n3. å»ºç«‹æ”¯æŒç³»ç»Ÿ"
            };
        }

        // æå–æŠ€èƒ½
        function extractSkills() {
            const stage5 = userAnswers.stage5 || [];
            const obstacles = stage5.filter(a => a.trim());
            
            if (obstacles.length > 0) {
                return `åŸºäºä½ è¯†åˆ«çš„éšœç¢ï¼Œéœ€è¦å‘å±•çš„æŠ€èƒ½åŒ…æ‹¬ï¼š\n${obstacles.map(o => `- åº”å¯¹${o}çš„èƒ½åŠ›`).join('\n')}\n\nå½“ä½ æ˜ç¡®å…·ä½“å­¦ä¹ æ–¹å‘åï¼Œå¯ä»¥åœ¨èµ„æºé¡µé¢æ‰¾åˆ°ç›¸å…³æ¨èã€‚`;
            }
            
            return "**æŠ€èƒ½å‘å±•å»ºè®®ï¼š**\nå½“ä½ æ˜ç¡®å…·ä½“çš„å­¦ä¹ æ–¹å‘åï¼Œç³»ç»Ÿä¼šæ ¹æ®ä½ çš„éœ€æ±‚æä¾›ä¸ªæ€§åŒ–èµ„æºæ¨èã€‚\n\n**é€šç”¨å»ºè®®ï¼š**\n1. å…ˆæ˜ç¡®1-2ä¸ªæœ€æ€¥éœ€çš„æŠ€èƒ½é¢†åŸŸ\n2. å¯»æ‰¾è¯¥é¢†åŸŸçš„ä¼˜è´¨å­¦ä¹ èµ„æº\n3. åˆ¶å®šå…·ä½“çš„å­¦ä¹ è®¡åˆ’å’Œæ—¶é—´å®‰æ’";
        }

        // æå–æ—¥å¸¸ç»“æ„
        function extractDailyRoutine() {
            const stage1 = userAnswers.stage1 || [];
            const currentRoutine = stage1[0] || "æš‚æ— è¯¦ç»†æ—¥å¸¸æè¿°";
            
            return `**å½“å‰æ—¥å¸¸æ¨¡å¼ï¼š**\n${currentRoutine}\n\n**ä¼˜åŒ–å»ºè®®ï¼š**\n1. æ™¨é—´ï¼šä¸“æ³¨è§„åˆ’ä¸å­¦ä¹ ï¼ˆ2-3å°æ—¶ï¼‰\n2. æ—¥é—´ï¼šæ·±åº¦å·¥ä½œä¸åˆ›é€ ï¼ˆ4-5å°æ—¶ï¼‰\n3. æ™šé—´ï¼šæ¢å¤ä¸åæ€ï¼ˆ1-2å°æ—¶ï¼‰\n4. ç¡å‰ï¼šå‡†å¤‡ä¸æ”¾æ¾ï¼ˆ30åˆ†é’Ÿï¼‰`;
        }

        // æå–å®æ–½ç­–ç•¥
        function extractStrategy() {
            const stage5 = userAnswers.stage5 || [];
            const obstacles = stage5.filter(a => a.trim());
            
            let strategy = "**ç¬¬1å‘¨è¯¦ç»†è®¡åˆ’ï¼š**\n1. å‘¨ä¸€ï¼šç†Ÿæ‚‰å·¥å…·ï¼Œè®¾å®šç›®æ ‡\n2. å‘¨äºŒï¼šå¼€å§‹æ¯æ—¥å¤ç›˜\n3. å‘¨ä¸‰ï¼šåˆ¶å®šå‘¨è®¡åˆ’\n4. å‘¨å››ï¼šæ‰§è¡Œä¸è°ƒæ•´\n5. å‘¨äº”ï¼šæ€»ç»“ä¸åº†ç¥\n6. å‘¨æœ«ï¼šä¼‘æ¯ä¸å‡†å¤‡\n\n";
            
            strategy += "**å‰3ä¸ªæœˆé‡Œç¨‹ç¢‘ï¼š**\n1. ç¬¬1ä¸ªæœˆï¼šå»ºç«‹åŸºæœ¬ä¹ æƒ¯\n2. ç¬¬2ä¸ªæœˆï¼šçœ‹åˆ°åˆæ­¥è¿›å±•\n3. ç¬¬3ä¸ªæœˆï¼šå½¢æˆç¨³å®šç³»ç»Ÿ\n\n";
            
            if (obstacles.length > 0) {
                strategy += "**éšœç¢åº”å¯¹ç­–ç•¥ï¼š**\n" + obstacles.map(o => `- ${o}ï¼šåˆ¶å®šå…·ä½“åº”å¯¹è®¡åˆ’`).join('\n');
            } else {
                strategy += "**é—®è´£å»ºè®®ï¼š**\n- ä½¿ç”¨æ¯æ—¥å¤ç›˜è·Ÿè¸ªè¿›åº¦\n- æ¯å‘¨æ£€æŸ¥ç›®æ ‡å®Œæˆæƒ…å†µ\n- å¯»æ‰¾ accountability partner";
            }
            
            return strategy;
        }

        // æ˜¾ç¤ºåœ°å›¾å†…å®¹
        function displayMap() {
            const mapContent = generateLifeResetMap();
            document.getElementById('mapContent').textContent = mapContent;
        }

        // ä¸‹è½½åœ°å›¾
        function downloadMap(format) {
            const mapContent = generateLifeResetMap();
            const now = new Date();
            const filename = `äººç”Ÿé‡ç½®åœ°å›¾_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
            
            if (format === 'markdown') {
                // ä¸‹è½½Markdownæ–‡ä»¶
                const blob = new Blob([mapContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Markdownæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼');
            } else if (format === 'pdf') {
                // æç¤ºPDFåŠŸèƒ½
                alert('PDFå¯¼å‡ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œç›®å‰è¯·ä½¿ç”¨æ‰“å°åŠŸèƒ½æˆ–Markdownä¸‹è½½ã€‚');
            }
        }

        // æ‰“å°åœ°å›¾
        function printMap() {
            window.print();
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            const mapContent = generateLifeResetMap();
            navigator.clipboard.writeText(mapContent).then(() => {
                alert('åœ°å›¾å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶ã€‚');
            });
        }

        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate(templateName) {
            const templateFiles = {
                'daily-review': '/templates/æ¯æ—¥å¤ç›˜æ¨¡æ¿.md',
                'weekly-plan': '/templates/å‘¨è®¡åˆ’æ¨¡æ¿.md',
                'resources': '/resources.html'
            };
            
            if (templateFiles[templateName]) {
                if (templateName === 'resources') {
                    window.open(templateFiles[templateName], '_blank');
                } else {
                    // ç›´æ¥ä¸‹è½½æ–‡ä»¶
                    const link = document.createElement('a');
                    link.href = templateFiles[templateName];
                    link.download = templateName === 'daily-review' ? 'æ¯æ—¥å¤ç›˜æ¨¡æ¿.md' : 'å‘¨è®¡åˆ’æ¨¡æ¿.md';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåœ°å›¾
        document.addEventListener('DOMContentLoaded', displayMap);
    </script>
</body>
</html>